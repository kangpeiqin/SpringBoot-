## 消息中间件
- 简介
> 消息是指在应用间传递的数据。消息中间件是指利用高效可靠的消息传递机制进行与平台无关的数据交流。
> 两种模式：点对点、发布订阅
- 作用
> 流量削峰、系统解耦(消息发布与订阅)、异步通信。
#### 生产者
作为消息系统的客户端，生产消息，并投递到消息系统中
#### 消费者
从消息系统中获取消息并进行相应的处理
### [RabbitMQ](http://rabbitmq.mr-ping.com/tutorials_with_python/[1]Hello_World.html)
> 一个由 `Erlang` 语言开发的 AMQP 的开源实现。
#### AMQP(高级队列协议)
#### 特点
- 可靠性：使用**持久化、传输确认、发布确认**等保证可靠性。
- 灵活的路由：通过 Exchange 来路由消息。
- 消息集群：多个 RabbitMQ 服务器可以组成一个集群
#### Q&A
- 生产者在消息投递过程中丢数据问题
> `RabbitMQ` 提供`transaction`和`confirm`模式来确保生产者不丢消息
> - 事务机制：如果发送过程中出现什么异常，就会进行回滚。缺点：缺点就是吞吐量下降了。
> - 发送方确认机制：一旦消息被投递到所有匹配的队列之后，`RabbitMQ`就会发送一个`Ack`给生产者

### Kafka
#### 基本概念
- 主题和分区
> - 消息通过主题进行分类。
> - 一个主题可以包含多个分区，消息被追加写入分区的尾部。通过分区来实现数据冗余和伸缩性。分区可以分布在不同的服务器上。
```text
          主题 "topicName"
分区0：  --------------------     <——
分区1：  -----------------       <—— 消息写入
....    --------------------      <——
```
- 批次
> 属于同一主题和分区的一组消息，可以将消息分成批次传输，较少网络开销。
- 偏移量
> 是一个不断递增的数值，用来区分已经读取过的消息。在给定分区里，每个消息的偏移量都是唯一的。
消费者把每个分区最后读取的消息偏移量保存在 `Zookeeper` 或者 `Kafka` 上，这样如果消费者关闭或者重启，它的读取状态不会丢失。
- `broker`和集群
> 一个独立的`Kafka`服务器被称为`broker`。`broker`接收来自生产者的消息，为消息设置偏移量，并提交消息到磁盘保存。
为消费者提供服务，对读取分区的请求作出响应，返回已经提交到磁盘上的消息。
## `Q & A`
### 如何保证消息不丢失
> 分析消息在哪些阶段可能会发生丢失并做出相应的补足措施。 
> - 生产者 --> 消息队列 ---> 消费者
> > - 生产者发送消息到 `Broker`：需要处理好Broker的响应，出错情况下利用重试、报警等手段。
> > - 消费者需要在执行完真正的业务逻辑之后再返回响应给Broker
> 
>影响：可靠性增强，性能下降。
### 如何保证消息的有序性
> - 全局有序：一个生产者+一个消息队列+单线程消费者
> - 局部有序：把消息通过特定的策略发送到固定的队列中，然后每个队列对应一个单线程处理的消费者。
### 重复消息如何处理
> 分析重复消息出现的原因：
> 一般情况下，为了保证消息发送的可靠性，我们发完消息都要等待`Broker`的响应，确认消息是否发送到`Broker`当中，
> 有可能出现`Broker`已经写入消息了，当时响应由于网络原因生产者没有收到，然后生产者又重发了一次，此时消息就重复了。
> - 解决方案
> > 业务上做幂等性处理
### 消息堆积如何处理
> 消息堆积的原因：生产者的生产速度与消费者的消费速度不匹配。
